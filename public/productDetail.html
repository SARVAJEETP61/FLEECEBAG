<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <link rel="stylesheet" href="css/product.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css">
    <script src="/controllers/index.js"></script>
    <script src="/controllers/script.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

</head>

<body>
    <div id="header-container"></div> <!-- Header will be injected here -->

    <div class="container mt-5">
        <a href="javascript:history.back()" class="btn btn-secondary mb-3">
            &larr; Back
        </a>
        <div class="product-details shadow-lg">

            <img id="productImage" class="product-image" src="" alt="Product Image">
            <h2 id="productName" class="text-center"></h2>
            <div class="product-info">
                <p id="productDiscountedPrice" class="fw-bold">$1000</p>

            </div>
            <p id="staticDescription"></p>

            <br>
            <div class="button-container">
                <a class="btn btn-outline-dark mt-auto" onclick=" handleAddToCart()">Add to
                    cart</a>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let userId;

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.error('User  is not logged in: No JWT token found');
                return;
            }

            try {
                const decoded = jwt_decode(token);
                userId = decoded.userId;

                if (!userId) {
                    console.error('User  ID not found in token');
                    return;
                }

                console.log('Decoded User ID:', userId);

                getNewProducts();
                getBestProducts();
            } catch (error) {
                console.error('Error decoding JWT token:', error);
            }

            // Get the product details from the URL query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const item_id = urlParams.get('id');
            const productName = urlParams.get('name');
            const productType = urlParams.get('type');
            const productColor = urlParams.get('color'); // Ensure this line i
            const productDiscount = urlParams.get('discount');
            const productPrice = urlParams.get('price');
            const productDiscountedPrice = urlParams.get('discountedPrice');
            const productIsNew = urlParams.get('isNew');
            const productIsInOffer = urlParams.get('isInOffer');
            const productIsBestDeal = urlParams.get('isItBestDeal');
            const productImage = urlParams.get('image');

            console.log(`Fetching details for product: ${productName}`);

            // Update the DOM with the product details
            document.getElementById('productName').textContent = productName || "Product name not found.";
            document.getElementById('productImage').src = productImage || "default_image.jpg"; // Fallback image
            // document.getElementById('productDescription').textContent = `Discount: -${productDiscount || "N/A"}`;
            // document.getElementById('productDiscountedPrice').textContent = `Price: $${productDiscountedPrice || productPrice || "N/A"}`;
            document.getElementById('productDiscountedPrice').innerHTML = `
    <span class="text-muted text-decoration-line-through">Was: ₹${productPrice || "N/A"}</span>
    <p class="price">Now: ₹${productDiscountedPrice || productPrice || "N/A"}</p>


            `;
            const colorText = productColor ? `This product is available in a stunning ${productColor} color.` : 'Color information not available.';
            const typeText = productType ? `Crafted for those who value both style and utility, this ${productType} is designed to complement your daily lifestyle.` : 'Type information not available.';

            const detailedDescription = `
    Discover the premium ${productName || 'product'} crafted for excellence. 
    Available in a sleek variety of colors, this versatile ${productType || 'item'} blends style and functionality seamlessly.
`;
            document.getElementById('staticDescription').textContent = detailedDescription;
        });

        async function handleAddToCart() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert("You need to be logged in to add items to the cart.");
                window.location.href = "/login.html";
                return;
            }

            // Get product details from URL
            const urlParams = new URLSearchParams(window.location.search);
            const item_id = urlParams.get('id');
            const productName = urlParams.get('name');
            const productPrice = parseFloat(urlParams.get('price')); // Ensure price is a number
            const productImage = urlParams.get('image');
            const discountedPrice = parseFloat(urlParams.get('discountedPrice')) || productPrice;
            const shippingCharge = parseFloat(urlParams.get('shippingCharge')) || 10; // Default charge

            let userId;
            try {
                const decoded = jwt_decode(token);
                userId = decoded.userId;
            } catch (error) {
                console.error("Error decoding JWT token:", error);
                return;
            }

            try {
                // Step 1: Fetch existing cart data
                const response = await fetch(`http://localhost:8080/api/cart/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error("Failed to fetch cart data");
                }

                const cartData = await response.json();

                // Ensure `items` array exists
                const cartItems = cartData.items || []; // Default to empty array if undefined
                let existingItem = cartItems.find(item => item.item_id === item_id);

                if (existingItem) {
                    // Step 2: Item exists, increase quantity
                    existingItem.quantity += 1;

                    const updateResponse = await fetch(`http://localhost:8080/api/cart/update/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            userId,
                            items: cartItems // Send the updated cart data
                        })
                    });

                    if (!updateResponse.ok) {
                        throw new Error("Failed to update cart quantity");
                    }

                    alert('Cart quantity updated!');
                } else {
                    // Step 3: Item doesn't exist, add new item
                    const cartItem = {
                        userId,
                        items: [
                            {
                                item_id,
                                name: productName,
                                price: productPrice,
                                discountedPrice,
                                image: productImage,
                                quantity: 1,
                                shippingCharge
                            }
                        ]
                    };

                    const addResponse = await fetch(`http://localhost:8080/api/cart/create/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(cartItem)
                    });

                    if (!addResponse.ok) {
                        throw new Error("Failed to add product to cart");
                    }

                    alert('Product added to cart successfully!');
                }

                localStorage.setItem("cartUpdated", "true");

            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }




    </script>
</body>

</html>
