<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <link rel="stylesheet" href="css/product.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css">
    <script src="/controllers/index.js"></script>
    <script src="/controllers/script.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

</head>

<body>
    <div id="header-container"></div> <!-- Header will be injected here -->

    <div class="container mt-5">
        <a href="javascript:history.back()" class="btn btn-secondary mb-3">
            &larr; Back
        </a>
        <div class="product-details shadow-lg">

            <img id="productImage" class="product-image" src="" alt="Product Image">
            <h2 id="productName" class="text-center"></h2>
            <div class="product-info">
                <p id="productPrice" class="fw-bold">$1000</p>
                <p id="productDescription" class="text-muted">Product description goes here</p>
            </div>
            <br>
            <div class="button-container">
                <a class="btn btn-outline-dark mt-auto" onclick=" handleAddToCart()">Add to
                    cart</a>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let userId;

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.error('User  is not logged in: No JWT token found');
                return;
            }

            try {
                const decoded = jwt_decode(token);
                userId = decoded.userId;

                if (!userId) {
                    console.error('User  ID not found in token');
                    return;
                }

                console.log('Decoded User ID:', userId);

                getNewProducts();
                getBestProducts();
            } catch (error) {
                console.error('Error decoding JWT token:', error);
            }

            // Get the product details from the URL query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const item_id = urlParams.get('id');
            const productName = urlParams.get('name');
            const productType = urlParams.get('type');
            const productDiscount = urlParams.get('discount');
            const productPrice = urlParams.get('price');
            const productDiscountedPrice = urlParams.get('discountedPrice');
            const productIsNew = urlParams.get('isNew');
            const productIsInOffer = urlParams.get('isInOffer');
            const productIsBestDeal = urlParams.get('isItBestDeal');
            const productImage = urlParams.get('image');

            console.log(`Fetching details for product: ${productName}`);

            // Update the DOM with the product details
            document.getElementById('productName').textContent = productName || "Product name not found.";
            document.getElementById('productImage').src = productImage || "default_image.jpg"; // Fallback image
            document.getElementById('productDescription').textContent = `Discount: ${productDiscount || "N/A"}%`;
            document.getElementById('productPrice').textContent = `Price: $${productDiscountedPrice || productPrice || "N/A"}`;
        });
        function handleAddToCart() {
            const token = localStorage.getItem('jwtToken'); // Check if user is logged in

            if (!token) {
                alert("You need to be logged in to add items to the cart.");
                window.location.href = "/login.html"; // Redirect to login page
                return;
            }

            // Extract product details from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const item_id = urlParams.get('id');
            const productName = urlParams.get('name');
            const productType = urlParams.get('type');
            const productDiscount = urlParams.get('discount');
            const productPrice = urlParams.get('price');
            const productDiscountedPrice = urlParams.get('discountedPrice');
            const productIsNew = urlParams.get('isNew');
            const productIsInOffer = urlParams.get('isInOffer');
            const productIsBestDeal = urlParams.get('isItBestDeal');
            const productImage = urlParams.get('image');

            // Get userId from JWT token (decode token)
            let userId;
            try {
                const decoded = jwt_decode(token); // Decoding the JWT token
                userId = decoded.userId;
            } catch (error) {
                console.error("Error decoding JWT token:", error);
                return;
            }

            // Create the cart item object
            const cartItem = {
                userId, // Add userId here
                item_id,
                name: productName,
                type: productType,
                discount: productDiscount,
                price: productPrice,
                discountedPrice: productDiscountedPrice,
                isNew: productIsNew === 'true', // Convert to boolean
                isInOffer: productIsInOffer === 'true', // Convert to boolean
                isItBestDeal: productIsBestDeal === 'true', // Convert to boolean
                image: productImage
            };

            console.log('Adding to cart:', cartItem);

            // Send the POST request to add the item to the cart
            fetch('http://localhost:8080/api/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // If you are using JWT for authentication
                },
                body: JSON.stringify(cartItem)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error('Server response:', err); // Log the server response
                            throw new Error(err.error || 'Failed to add to cart');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Product added to cart:', data);
                    alert('Product added to cart successfully!');
                })
                .catch(error => {
                    console.error('Error adding product to cart:', error);
                    alert(`Failed to add product to cart: ${error.message}`);
                });
        }

        // function handleAddToCart() {
        //     const token = localStorage.getItem('jwtToken'); // Check if user is logged in

        //     if (!token) {
        //         alert("You need to be logged in to add items to the cart.");
        //         window.location.href = "/login.html"; // Redirect to login page
        //         return;
        //     }

        //     // Extract product details from URL parameters
        //     const urlParams = new URLSearchParams(window.location.search);
        //     const productId = urlParams.get('id');
        //     const productName = urlParams.get('name');
        //     const productType = urlParams.get('type');
        //     const productDiscount = urlParams.get('discount');
        //     const productPrice = urlParams.get('price');
        //     const productDiscountedPrice = urlParams.get('discountedPrice');
        //     const productIsNew = urlParams.get('isNew');
        //     const productIsInOffer = urlParams.get('isInOffer');
        //     const productIsBestDeal = urlParams.get('isItBestDeal');
        //     const productImage = urlParams.get('image');

        //     // Create the cart item object
        //     const cartItem = {
        //         productId,
        //         name: productName,
        //         type: productType,
        //         discount: productDiscount,
        //         price: productPrice,
        //         discountedPrice: productDiscountedPrice,
        //         isNew: productIsNew === 'true', // Convert to boolean
        //         isInOffer: productIsInOffer === 'true', // Convert to boolean
        //         isItBestDeal: productIsBestDeal === 'true', // Convert to boolean
        //         image: productImage
        //     };
        //     console.log('Adding to cart:', cartItem);

        //     // Send the POST request to add the item to the cart
        //     fetch('http://localhost:8080/api/cart', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             'Authorization': `Bearer ${token}` // If you are using JWT for authentication
        //         },
        //         body: JSON.stringify(cartItem)
        //     })
        //         .then(response => {
        //             if (!response.ok) {
        //                 return response.json().then(err => {
        //                     console.error('Server response:', err); // Log the server response
        //                     throw new Error(err.error || 'Failed to add to cart');
        //                 });
        //             }
        //             return response.json();
        //         })
        //         .then(data => {
        //             console.log('Product added to cart:', data);
        //             alert('Product added to cart successfully!');
        //         })
        //         .catch(error => {
        //             console.error('Error adding product to cart:', error);
        //             alert(`Failed to add product to cart: ${error.message}`);
        //         });
        // }

    </script>
</body>

</html>
