<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Fleecebag - Cart</title>
    <link rel="icon" href="images/purse.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="/css/cart.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/controllers/index.js"></script>
    <script src="/controllers/script.js" defer></script>

</head>

<body>
    <div id="header-container"></div>

    <section class="h-100">
        <div class="container py-5">
            <div class="row d-flex justify-content-center my-4">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Cart - <span id="cartItemCount">0</span> items</h5>
                            <button class="btn btn-danger" onclick="clearCart(userId)">Clear Cart</button>
                        </div>

                        <div class="card-body" id="cartItemsContainer">
                        </div>
                    </div>
                </div>
                <!-- Summary Section -->
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header py-3">
                            <h5 class="mb-0">Summary</h5>

                            <!-- <button class="add-to-cart-btn" onclick="addToCart()">Add to Cart</button> -->
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                    Products
                                    <span id="summaryTotalPrice">0</span>
                                </li>

                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                    Discount
                                    <span id="discount">-0</span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                    Shipping
                                    <span id="summaryShippingFee">0</span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <strong>Total</strong>
                                    <strong>$<span id="finalTotal">0</span></strong>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>


    <script>
        let userId;

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');


            if (!token) {
                console.error('User is not logged in: No JWT token found');
                return;
            }

            try {
                const decoded = jwt_decode(token);
                userId = decoded.userId;

                if (!userId) {
                    console.error('User ID not found in token');
                    return;
                }

                console.log('Decoded User ID:', userId);

                getItems(userId);
            } catch (error) {
                console.error('Error decoding JWT token:', error);
            }
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const itemId = button.dataset.itemId;
                    const userId = button.dataset.userId; // Assuming userId is stored in a data attribute
                    removeItem(itemId, userId);
                });
            });

        });
        function getItems(userId) {
            fetch(`/cart/${userId}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch cart data');
                    }
                    return response.json();
                })
                .then((data) => {
                    if (data.statusCode === 200 && data.data[0]) {
                        const cart = data.data[0];
                        const cartItems = cart.item;
                        console.log('Cart Data:', data);
                        const cartItemsContainer = document.getElementById('cartItemsContainer');
                        const cartItemCount = document.getElementById('cartItemCount');
                        const summaryTotalPrice = document.getElementById('summaryTotalPrice');
                        const summaryShippingFee = document.getElementById('summaryShippingFee');
                        const discountElement = document.getElementById('discount');
                        const finalTotal = document.getElementById('finalTotal');

                        // Check if elements exist
                        if (!cartItemsContainer || !cartItemCount || !summaryTotalPrice || !summaryShippingFee || !discountElement || !finalTotal) {
                            console.error('Required DOM elements not found.');
                            return;
                        }

                        let totalQuantity = 0;
                        cartItems.forEach(item => {
                            totalQuantity += item.quantity; // Sum up the quantities of all items
                        });

                        cartItemCount.textContent = totalQuantity;

                        let cartItemsHtml = '';
                        let totalPrice = 0;
                        let totalShippingFee = 0;
                        let totalDiscount = 0;

                        if (cartItems.length === 0) {
                            cartItemsHtml = `<p>Your cart is empty.</p>`;
                        } else {
                            cartItems.forEach((item) => {
                                // Calculate total price, shipping, and discount
                                const itemTotalPrice = item.price * item.quantity;
                                const itemDiscountedPrice = item.discountedPrice * item.quantity;
                                const itemShippingFee = item.shippingCharge * item.quantity;

                                totalPrice += itemTotalPrice;
                                totalShippingFee += itemShippingFee;
                                totalDiscount += (itemTotalPrice - itemDiscountedPrice);

                                // Adjusted HTML structure based on new item structure
                                cartItemsHtml += `
                            <div class="row">
                                <div class="col-lg-3 col-md-12 mb-4 mb-lg-0">
                                    <div class="bg-image hover-overlay hover-zoom ripple rounded" data-mdb-ripple-color="light">
                                        <img src="${item.image}" class="w-100" />
                                    </div>
                                </div>
                                <div class="col-lg-5 col-md-6 mb-4 mb-lg-0">
                                    <p><strong>${item.name}</strong></p>
                                    
                                    <p>Price: $<span>${item.discountedPrice}</span></p>
                                    <p>Quantity: <span>${item.quantity}</span></p>
                                </div>
                                <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
                                    <div class="d-flex mb-4" style="max-width: 300px">
                                        <button class="btn btn-login px-3 me-2" data-item-id="${item.item_id}" data-user-id="${userId}" onclick="decreaseQuantity('${item.item_id}', '${userId}')">
    <i class="fas fa-minus"></i>
</button>

                                        <div class="form-outline text-center">
                                            <label class="form-label" for="pass-quantity">${item.quantity}</label>
                                            
                                        </div>
                                        <button class="btn btn-login px-3 ms-2" data-item-id="${item.item_id}" data-user-id="${userId}" onclick="increaseQuantity('${item.item_id}', '${userId}')">
    <i class="fas fa-plus"></i>
</button>

                                    </div>
                                    
                                    <p class="text-start text-md-center"><strong>$<span>${itemDiscountedPrice.toFixed(2)}</span></strong></p>
                                    
                                    <button class="btn btn-danger" onclick="removeItem('${item.item_id}', '${userId}')">Remove</button>
                                </div>
                            </div>
                            <hr class="my-4" />
                        `;
                            });
                        }

                        // Update the cart items container
                        cartItemsContainer.innerHTML = cartItemsHtml;

                        // Update the summary
                        summaryTotalPrice.textContent = totalPrice.toFixed(2);
                        summaryShippingFee.textContent = totalShippingFee.toFixed(2);
                        discountElement.textContent = `-$${totalDiscount.toFixed(2)}`;
                        const finalPrice = totalPrice + totalShippingFee - totalDiscount;
                        finalTotal.textContent = finalPrice.toFixed(2);
                    } else {
                        // console.error('Error fetching cart items:', data.message);
                    }
                })
                .catch((error) => {
                    // console.error('Error fetching cart items:', error);
                });
        }
        function decreaseQuantity(itemId, userId) {
            console.log('Decreasing quantity for item:', itemId);

            try {
                // Fetch the current cart
                fetch(`/api/cart/${userId}`)
                    .then((response) => {
                        if (!response.ok) throw new Error("Failed to fetch cart");

                        return response.json();
                    })
                    .then(async (data) => {
                        console.log('Cart Data:', data);

                        if (data.statusCode === 200 && data.data[0]) {
                            let cartItems = data.data[0].item; // Existing cart items
                            let item = cartItems.find(i => i.item_id === itemId);

                            if (!item) {
                                console.error('Item not found in cart.');
                                return;
                            }

                            // Step 1: Decrease quantity by 1, ensuring it doesn't go below 1
                            if (item.quantity > 1) {
                                item.quantity -= 1;
                                item.totalPrice = item.discountedPrice * item.quantity; // Update the total price for the item

                                // Step 2: Update cart with new quantity
                                const updateResponse = await fetch(`/api/cart/update`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        userId,
                                        item_id: itemId,
                                        quantity: item.quantity  // Updated quantity
                                    })
                                });

                                if (!updateResponse.ok) throw new Error("Failed to update cart quantity");
                                console.log('Cart quantity decreased!');
                            } else {
                                // Step 3: Remove item if quantity is 1
                                const deleteResponse = await fetch('/api/cart/remove', {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId, item_id: itemId })
                                });

                                if (!deleteResponse.ok) throw new Error("Failed to remove item");
                                console.log('Item removed from cart!');
                            }

                            // Step 4: Fetch updated cart to reflect changes
                            getItems(userId); // This function will re-render the updated cart with new quantity or item removal
                        } else {
                            console.error('Cart not found or empty.');
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error.message);
                    });
            } catch (error) {
                console.error('Error decreasing quantity:', error);
            }
        }



        function increaseQuantity(itemId, userId) {
            console.log('Increasing quantity for item:', itemId);

            try {
                // Fetch the current cart
                fetch(`/api/cart/${userId}`)
                    .then((response) => {
                        if (!response.ok) throw new Error("Failed to fetch cart");

                        return response.json();
                    })
                    .then(async (data) => {
                        console.log('Cart Data:', data);

                        if (data.statusCode === 200 && data.data[0]) {
                            let cartItems = data.data[0].item; // Existing cart items
                            let item = cartItems.find(i => i.item_id === itemId);

                            if (!item) {
                                console.error('Item not found in cart.');
                                return;
                            }

                            // Step 1: Increase quantity by 1
                            item.quantity += 1;
                            item.totalPrice = item.price * item.quantity; // Update the total price for the item

                            // Step 2: Update cart with new quantity
                            const updateResponse = await fetch(`/api/cart/update`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId,        // Now passed in the request body
                                    item_id: itemId,
                                    quantity: item.quantity  // Updated quantity
                                })
                            });

                            if (!updateResponse.ok) throw new Error("Failed to update cart quantity");
                            console.log('Cart quantity increased!');

                            // Step 3: Fetch updated cart to reflect changes
                            getItems(userId); // This function will re-render the updated cart with new quantity
                        } else {
                            console.error('Cart not found or empty.');
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error.message);
                    });
            } catch (error) {
                console.error('Error increasing quantity:', error);
            }
        }

        async function clearCart() {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.error('No JWT token found. User must log in.');
                return;
            }

            let userId;
            try {
                const decoded = jwt_decode(token);
                userId = decoded.userId;
            } catch (error) {
                console.error('Error decoding JWT token:', error);
                return;
            }

            try {
                document.getElementById('cartItemsContainer').innerHTML = '';
                document.getElementById('cartItemCount').textContent = '0';
                document.getElementById('summaryTotalPrice').textContent = '$0';
                document.getElementById('summaryShippingFee').textContent = '$0';
                document.getElementById('finalTotal').textContent = '$0';
                document.getElementById('discount').textContent = "$0"

                const response = await fetch(`/cart/removeAll/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();


            } catch (error) {
                // console.error('Error while clearing cart:', error);
            }
        }

        async function removeItem(item_id, userId) {
            console.log('Attempting to remove item:', item_id);

            try {
                // Fetch the current cart
                const response = await fetch(`/api/cart/${userId}`);
                if (!response.ok) throw new Error("Failed to fetch cart");

                const data = await response.json();
                console.log('Cart Data:', data); // Debugging

                if (data.statusCode === 200 && data.data[0]) {
                    let cartItems = data.data[0].item; // Existing cart items
                    let item = cartItems.find(i => i.item_id === item_id);

                    if (!item) {
                        console.error('Item not found in cart.');
                        return;
                    }

                    if (item.quantity > 1) {
                        // Step 1: Decrease quantity if greater than 1
                        item.quantity -= 1;
                        item.totalPrice = item.price * item.quantity; // Update the total price for the item

                        const updateResponse = await fetch(`/api/cart/update`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId,        // Now passed in the request body
                                item_id,
                                quantity: item.quantity  // Updated quantity
                            })
                        });

                        if (!updateResponse.ok) throw new Error("Failed to update cart quantity");
                        console.log('Cart quantity decreased!');
                    } else {
                        // Step 2: Remove item completely if quantity is 1
                        const deleteResponse = await fetch('/api/cart/remove', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId, item_id })
                        });

                        if (!deleteResponse.ok) throw new Error("Failed to remove item");
                        console.log('Item removed from cart!');
                    }

                    // Fetch updated cart to reflect changes
                    getItems(userId);
                } else {
                    console.error('Cart not found or empty.');
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        }


    </script>


</body>

</html>
